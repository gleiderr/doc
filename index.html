<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-16">
	<title>Graph-it</title>
</head>

<style type="text/css">
	.nodo {
		border-left: solid;
		border-left-width: 1px;
		border-left-style: dotted;
		padding-left: 13px;
	}
	.referencia {
		border-left-color: cornflowerblue;
		font-size: small;
		background: aliceblue;
	}
	.expansivel {
		cursor: pointer;
	}
</style>
<body>
	
	<script type="text/javascript">
		let json = null;

		init();

		function init() {
			let input = document.createElement('div');
			input.innerHTML = '<input id="input" type="file" name="" accept=".json" oninput="handle(this.files)">';
			input = input.firstChild;

			document.body.innerHTML = '';
			document.body.appendChild(input);
		};

		class Graphit {
			constructor (obj, id) {
				this.obj = obj;
				this.id = id;
				this.node = obj[id];
			}

			get children() {
				let a = [];
				if(this.node.content) {
					for(let i = 0; i < this.node.content.length; i++) {
						a.push(new Graphit(this.obj, this.node.content[i]));
					}
				}
				return a;
			}

			get next() {
				if(this.obj[this.id].next) return new Graphit(this.obj, this.node.next);
				return null;
			}

			get neighborhood() {
				let es = [];
				if (this.node.multi_edges){
					for (let multi_edge of this.node.multi_edges) {
						let edge_text = multi_edge[0];
						for(let i = 1; i < multi_edge.length; i++) {
							let node = new Graphit(this.obj, multi_edge[i]);
							es.push({edge_text, node});
						}
					}
				}
				return es;
			}

			get text() {
				return this.node.text;
			}

			hasEdges() {
				return Boolean(this.node.content || (this.node.multi_edges && this.node.multi_edges.length));
			}
		}
		
		function handle(files) {
			var reader = new FileReader();
			reader.onload = (e) => {
				json = JSON.parse(e.target.result);
				graphit(JSON.parse(e.target.result));
			};

			reader.readAsText(files[0]);
		}

		function graphit(json) {
			init();
			//Exibe conteúdo de "0" em uma filha de <body>
			let first = new Graphit(json, '0');
			document.body.appendChild(ell(first, `<div class="nodo">${first.text}</div>)`));

			document.body.addEventListener('dblclick', event => {
				if(event.target.classList.contains('expansivel')) {
					event.target.classList.remove('expansivel');
					expand(event.target);
				}
				event.stopPropagation();
			});
		}		

		function ell(node, content) {
			let e = document.createElement('div');
			e.innerHTML = content;

			e = e.firstChild;
			e.setAttribute('data-nodo', node.id);

			if(node.hasEdges()) e.classList.add('expansivel');

			return e;
		}

		function expand(element) {
			let n = new Graphit(json, element.getAttribute('data-nodo'));

			//Exibição das referências
			for(let neighbor of n.neighborhood) {
				let content = '<div class="nodo referencia">'
							  +	`${neighbor.edge_text}: ${neighbor.node.text}`
							  + '</div>';
				element.appendChild(ell(neighbor.node, content));
			}

			//Exibição do conteúdo
			for (let child of n.children){
				element.appendChild(ell(child, `<div class="nodo">${child.text}</div>`));
			}
		}
	</script>
</body>
</html>
